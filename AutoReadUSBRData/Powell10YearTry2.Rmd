---
title: "Lake Powell Releases"
author: "David E. Rosenberg"
date: "January 13, 2026"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This is an R Markdown document. This document reads daily USBR data on Lake Powell  Releases (Auto download daily data from Reclamation's HydroData portal - https://www.usbr.gov/uc/water/hydrodata/reservoir_data/site_map.html. The code aggregates data to yearly (water year starting Oct 1), 9-year, and decadal values and then compares Lake Powell releases to The 1922 Compact Article 3(d) requirement. The document alsow shows histograms of Powell inflows and realeases.

* 10-year 74.8 maf requirement: Upper Basin delivers to Lower Basin by Article 3(d) of 1922 Compact
* 10-year 82.3 maf requirement: Upper Basin delivers to Lower Basin by 1922 Compact Article 3(d) and half of 1.5 maf per year United States obligation to Mexico by 1944 Treaty.
* Presently, the Upper Basin's 0.75 maf per year obligation to Mexico may be revised down by contigency plans in Minutes 319 and 323 to US-Mexico Treaty.
* 9-Year target is used to show Upper Basin flexibility to allow inflow to pass to Lower Basin in current 10th year.

## Requested Citation
David E. Rosenberg (2026), "Lake Powell Annual and 10-Year Releases." Utah State University. Logan, Utah. https://github.com/dzeke/ColoradoRiverFutures/tree/master/Powell10year.

```{r LakeMeadStorageICS1, echo=FALSE, warning=FALSE, message=FALSE}

rm(list = ls())  #Clear history

# Load required libraries in 1 go
# List of packages
load.lib <- c("tidyverse", "readxl", "RColorBrewer", "dplyr", "expss", "reshape2", "pracma", "lubridate", "directlabels", "plyr", "stringr", "ggplot2", "ggpubr", "ggrepel", "zoo")
# Then we select only the packages that aren't currently installed.
install.lib <- load.lib[!load.lib %in% installed.packages()]
# And finally we install the missing packages, including their dependency.
for(lib in install.lib) install.packages(lib,dependencies=TRUE)
# After the installation process completes, we load all packages.
sapply(load.lib,require,character=TRUE)

# Read in daily Lake Powell release from Reclamation's HydroPortal
# Details
# Lake Powell is Reservoir Code 919
# Lake Powell total release is Code 42
#
# Thus the download query to CSV format is https://www.usbr.gov/uc/water/hydrodata/reservoir_data/919/csv/42.csv

sPowellReleaseDataCode <- 'https://www.usbr.gov/uc/water/hydrodata/reservoir_data/919/csv/42.csv'

# File name to read in Mead end of month reservoir level in feet - cross tabulated by year (1st column) and month (subsequent columns)
#    LAKE MEAD AT HOOVER DAM, END OF MONTH ELEVATION (FEET), Lower COlorado River Operations, U.S. Buruea of Reclamation
#    https://www.usbr.gov/lc/region/g4000/hourly/mead-elv.html

# Read in the historical Powell data
dfPowellHistorical <- read.csv(file=sPowellReleaseDataCode, 
                               header=TRUE, 
                               
                               stringsAsFactors=FALSE,
                               sep=",")


#Interpolate Powell storage from level to check
## For 2020 data

dfPowellHist <- dfPowellHistorical
dDateInterval <- 365 # Days

#Convert date text to date value
dfPowellHist$DateValue <- as.POSIXct(dfPowellHist$datetime)

# Convert CFS to Acre-feet per month
nCFStoAFMon <- 60.37
nCFStoAFDay <- nCFStoAFMon/30.5

nCFSToAF <- nCFStoAFDay

#Calculate Day, Month, and Year
dfPowellHist$Year <- year(dfPowellHist$DateValue)
dfPowellHist$Month <- month(dfPowellHist$DateValue)
dfPowellHist$Day <- day(dfPowellHist$DateValue)

#Calculate Water Year
dfPowellHist$WaterYear <- ifelse(dfPowellHist$Month >= 10, dfPowellHist$Year + 1, dfPowellHist$Year)

#Calculate Annual flow in million acre-feet
dfPowellAnnual <- dfPowellHist %>% select(WaterYear, total.release) %>% group_by(WaterYear) %>% dplyr::summarize(AnnualRelease = sum(total.release)*nCFSToAF/1e6)

#Trim first and last years with incomplete data
nFirstYear <- min(dfPowellAnnual$WaterYear) + 1
nLastYear <-  max(dfPowellAnnual$WaterYear)

dfPowellAnnual <- dfPowellAnnual %>% filter(WaterYear > nFirstYear, WaterYear < nLastYear)

#10-year total release
dfPowellAnnual$TenYearRelease <- rollapply(dfPowellAnnual$AnnualRelease, 10,sum, fill=NA, align="right")
#9-year total
dfPowellAnnual$NineYearRelease <- rollapply(dfPowellAnnual$AnnualRelease, 9,sum, fill=NA, align="right")

#7.48 and 8.23 MAF annual targets
dfPowellAnnual$OneYearTarget <- 7.48  # Paria flow (0.02 maf per year adds 0.2 maf over 10 years)
dfPowellAnnual$OneYearTarget82 <- dfPowellAnnual$OneYearTarget + 0.75
dfPowellAnnual$TenYearTarget <- dfPowellAnnual$OneYearTarget * 10  # Paria flow (0.02 maf per year adds 0.2 maf over 10 years)
dfPowellAnnual$TenYearTarget82 <- dfPowellAnnual$TenYearTarget + 10*0.75


# # Difference between 10-year and target
# dfPowellAnnual$Diff75 <- dfPowellAnnual$TenYearRelease - dfPowellAnnual$TenYearTarget
# dfPowellAnnual$Diff82 <- dfPowellAnnual$TenYearRelease - dfPowellAnnual$TenYearTarget82


# # Add text for the decade
# # 10-year values
# dfPowellHistAnnual$Decade <- paste0(dfPowellHistAnnual$Year - 10 + 1," to ",dfPowellHistAnnual$Year)
# dfPowellHistAnnual$TenYearReleaseRnd <- round(dfPowellHistAnnual$TenYearRelease, digits=1)
# dfPowellHistAnnual$TenYearDiffRnd <- round(dfPowellHistAnnual$Diff, digits=1)
# 
# # 9-year value
# dfPowellHistAnnual$NineYearPeriod <- paste0(dfPowellHistAnnual$Year - 9 + 1," to ",dfPowellHistAnnual$Year)
# dfPowellHistAnnual$NineYearReleaseRnd <- round(dfPowellHistAnnual$NineYearRelease, digits=1)
# dfPowellHistAnnual$NineYearDiffRnd <- round(dfPowellHistAnnual$NineYearRelease - 8.23*9, digits=1)
# 
# # Select into two columns and reverse sort
# dfPowellByDecade <- dfPowellHistAnnual %>% arrange(Year, decreasing = TRUE) %>% select(Decade, TenYearReleaseRnd,TenYearDiffRnd, NineYearRelease) 

#Export to CSV
write.csv(dfPowellAnnual,"dfPowellAnnual.csv" )

#Get the color palettes
#Get the blue color bar
pBlues <- brewer.pal(9,"Blues")
pReds <- brewer.pal(9,"Reds")


```

# Figure 1: Lake Powell Annual Releases Compared to Target
```{r MeadStorageFig1, echo=FALSE, warning=FALSE, message=FALSE}

print("I made it here")

#### Figure 1. Annual Powell Release compared to 7.5 and 8.23 targets
#Pivot the Wide format to Longer for Plotting with different colors
dfPowellAnnualLong <- pivot_longer(data = dfPowellAnnual, cols = c(AnnualRelease, OneYearTarget, OneYearTarget82), names_to = "DataType", values_to = "Flow")
dfPowellAnnualLong$DataTypeFactor <- factor(dfPowellAnnualLong$DataType, levels = c("AnnualRelease", "OneYearTarget82", "OneYearTarget") )

ggplot(data = dfPowellAnnualLong %>% filter(WaterYear >= 1995), aes(x = WaterYear, y = Flow , color = DataTypeFactor, linetype = DataTypeFactor)) +
  #Powell release 
  geom_line(size=2) +

  scale_color_manual(labels = c("Annual Release", "8.23 Target", "7.48 Target"), values = c("AnnualRelease" = pBlues[8], "OneYearTarget82" =  pReds[7], "OneYearTarget" = pReds[4])) +
  scale_linetype_manual(labels = c("Annual Release", "8.23 Target", "7.48 Target"), values = c("AnnualRelease" = "solid", "OneYearTarget82" =  "dashed", "OneYearTarget" = "twodash")) +
  scale_x_continuous(breaks = seq(1970,2026,5)) +
  theme_bw() +
  #coord_fixed() +
  labs(x="", y="Powell Release\n(million acre-feet per year)") +
  theme(text = element_text(size=20), legend.title=element_blank(), legend.text=element_text(size=18))
  #theme(text = element_text(size=20), legend.text=element_text(size=16)